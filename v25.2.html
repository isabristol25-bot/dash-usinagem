<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dashboard - Usinagem Dia (versÃ£o 18.6)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>
  <style>
    canvas { width:100% !important; height:120px !important; }
    .prioridade-vermelho { background-color:#dc2626 !important; color:#000 !important; font-weight:700; }
    .prioridade-amarelo { background-color:#eab308 !important; color:#000 !important; font-weight:700; }
    .prioridade-verde { background-color:#16a34a !important; color:#000 !important; font-weight:700; }
    .wait-badge { width:28px; height:28px; min-width:28px; border-radius:9999px; display:inline-flex; align-items:center; justify-content:center; font-weight:800; border:2px solid rgba(0,0,0,0.8); margin-right:8px; }
    input:focus, select:focus, [contenteditable]:focus { outline: none; box-shadow: 0 0 0 2px rgba(56,189,248,0.2); }
    button.sort-btn { padding: 6px 8px; font-size: 0.85rem; }
  </style>
</head>
<body class="bg-gray-900 text-gray-100">
<header class="p-4 border-b border-gray-800">
  <h1 class="text-xl font-bold">DiÃ¡rio de produÃ§Ã£o â€” Usinagem Dia (v18.6)</h1>
  <div class="mt-2 flex gap-2">
    <button id="exportAll" class="px-3 py-1 bg-sky-600 rounded">Exportar tudo (CSV)</button>
    <button id="resetAll" class="px-3 py-1 bg-red-600 rounded">Resetar tudo</button>
  </div>
</header>
<main class="p-4 grid gap-4 grid-cols-1 lg:grid-cols-3">
  <section class="lg:col-span-3">
    <div id="machinesContainer" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
  </section>
</main>
<footer class="p-4 text-xs text-gray-500 border-t border-gray-800">
  VersÃ£o v18.6 â€” Agora com lista de espera editÃ¡vel e reordenÃ¡vel por prioridade ou arrasto manual.
</footer>
<template id="machine-template">
  <div class="p-4 bg-gray-800 rounded shadow">
    <div class="flex justify-between items-start gap-2">
      <div>
        <div class="text-lg font-semibold" data-role="title">MÃ¡quina</div>
        <div class="text-xs text-gray-400" data-role="subtitle">Operador: - Â· Ciclo: - Â· PeÃ§a: -</div>
      </div>
      <div class="text-right">
        <div class="text-sm text-gray-300">Previsto</div>
        <div class="text-2xl font-bold" data-role="predicted">0</div>
      </div>
    </div>
    <div class="mt-3 grid grid-cols-1 gap-2">
      <div class="flex flex-col gap-2">
        <input data-role="operator" placeholder="Operador" class="px-2 py-1 rounded bg-gray-700 text-sm" />
        <input data-role="process" placeholder="Processo / PeÃ§a" class="px-2 py-1 rounded bg-gray-700 text-sm" />
        <input data-role="cycle" placeholder="Tempo de ciclo (hh:mm:ss ou min decimal)" class="px-2 py-1 rounded bg-gray-700 text-sm" />
        <input data-role="troca" placeholder="Tempo de troca (hh:mm:ss ou min decimal)" class="px-2 py-1 rounded bg-gray-700 text-sm" />
        <input data-role="setup" placeholder="Tempo parada (min)" class="px-2 py-1 rounded bg-gray-700 text-sm" />
        <input data-role="startTime" type="time" class="px-2 py-1 rounded bg-gray-700 text-sm" />
        <input data-role="endTime" type="time" class="px-2 py-1 rounded bg-gray-700 text-sm" />
        <input data-role="produced" placeholder="PeÃ§as realizadas (inteiro)" class="px-2 py-1 rounded bg-gray-700 text-sm" />
        <input data-role="observacao" placeholder="ObservaÃ§Ã£o" class="px-2 py-1 rounded bg-gray-700 text-sm" />
      </div>
      <div class="flex gap-2 flex-wrap">
        <button data-role="save" class="px-2 py-1 bg-green-600 rounded text-sm">Salvar</button>
        <button data-role="addHistory" class="px-2 py-1 bg-sky-600 rounded text-sm">Adicionar ao HistÃ³rico</button>
        <button data-role="clearHistory" class="px-2 py-1 bg-red-600 rounded text-sm">Limpar HistÃ³rico</button>
      </div>
      <canvas data-role="chart" height="120"></canvas>
      <div data-role="performance" class="text-center text-sm font-semibold mt-1"></div>
      <div class="max-h-40 overflow-auto bg-gray-900/30 p-2 rounded text-sm" data-role="history"></div>
      <!-- Lista de espera -->
      <div class="mt-4">
        <h3 class="font-semibold text-sm mb-1">ðŸ•’ Processos Futuros</h3>
        <div class="flex gap-2 mb-2">
          <input data-role="futureInput" placeholder="Novo processo futuro" class="flex-1 px-2 py-1 rounded bg-gray-700 text-sm" />
          <select data-role="prioritySelect" class="px-2 py-1 rounded bg-gray-700 text-sm">
            <option value="vermelho">ðŸ”´ Urgente</option>
            <option value="amarelo">ðŸŸ¡ Alta</option>
            <option value="verde">ðŸŸ¢ Normal</option>
          </select>
          <button data-role="addFuture" class="px-2 py-1 bg-blue-600 rounded text-sm">Adicionar</button>
          <button data-role="sortFuture" class="px-2 py-1 bg-gray-600 rounded text-sm sort-btn">Ordenar</button>
        </div>
        <div data-role="futureList" class="space-y-1"></div>
      </div>
    </div>
  </div>
</template>

<script>
const MACHINE_NAMES = [
 'Fresa CNC 1','Fresa CNC 2','Fresa CNC 3','Robodrill 2','D 800-1','Fagor',
 'Robodrill 1','VTC','D 800-2','D 800-3','Centur','Nardine','GL 280',
 '15S','E 280','G 240','Galaxy 10A','Galaxy 10B','GL 170G','GL 250','GL 350','GL 450'
];
const firebaseConfig = {
 apiKey: "AIzaSyALyU3_v10EZzZMmN02RyXxpEficXRFtBY",
 authDomain: "usinagemdashboard.firebaseapp.com",
 databaseURL: "https://usinagemdashboard-default-rtdb.firebaseio.com",
 projectId: "usinagemdashboard",
 storageBucket: "usinagemdashboard.firebasestorage.app",
 messagingSenderId: "584772442861",
 appId: "1:5847720247ba0fe8468ae4"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const REF = db.ref('usinagem_dashboard_v18_6');

function parseTempoMinutos(str) {
 if (!str) return 0;
 const s = String(str).trim();
 if (s.includes(':')) {
   const parts = s.split(':').map(Number);
   if (parts.length === 3) { 
     return parts[0] * 60 + parts[1] + parts[2] / 60;
   }
   if (parts.length === 2) { 
     return parts[0] + parts[1] / 60;
   }
 }
 const v = Number(s.replace(',', '.'));
 return isNaN(v) ? 0 : v;
}

function formatMinutesToMMSS(minFloat) {
 if (!minFloat || isNaN(minFloat)) return '-';
 const totalSeconds = Math.round(minFloat * 60);
 const m = Math.floor(totalSeconds / 60);
 const s = totalSeconds % 60;
 return `${m}:${String(s).padStart(2, '0')}`;
}

function minutosDisponiveis(startStr, endStr) {
 if (!startStr || !endStr) return 0;
 function toMinutes(timeStr) {
   const parts = timeStr.split(':').map(Number);
   if (parts.length === 3) return parts[0] * 60 + parts[1] + parts[2] / 60;
   if (parts.length === 2) return parts[0] * 60 + parts[1];
   if (parts.length === 1) return parts[0] * 60;
   return 0;
 }
 const start = toMinutes(startStr);
 const end = toMinutes(endStr);
 let diff = end - start;
 if (diff <= 0) return 0;
 const lunchStart = toMinutes('12:00');
 const lunchEnd = toMinutes('13:00');
 if (end > lunchStart && start < lunchEnd) {
   const overlap = Math.min(end, lunchEnd) - Math.max(start, lunchStart);
   if (overlap > 0) diff -= overlap;
 }
 return diff;
}

//
// ðŸ”§ CORREÃ‡ÃƒO AQUI â€” TROCA POR CICLO
//
function calcularPrevisto(cycleMin, trocaMin, setupMin, startStr, endStr) {
 const totalDisponivel = Math.max(
   minutosDisponiveis(startStr, endStr) - (setupMin || 0),
   0
 );

 if (!cycleMin || cycleMin <= 0 || totalDisponivel <= 0) return 0;

 const cicloTotal = cycleMin + (trocaMin || 0); // troca por ciclo

 if (cicloTotal <= 0) return 0;

 return Math.floor(totalDisponivel / cicloTotal);
}

let state = { machines: [] };

function initDefaultMachines() {
 return MACHINE_NAMES.map(name => ({
   id: name,
   operator: '',
   process: '',
   cycleMin: null,
   setupMin: 0,
   trocaMin: null,
   observacao: '',
   startTime: '07:00',
   endTime: '16:45',
   produced: null,
   predicted: 0,
   history: [],
   future: []
 }));
}

function ensureFutureArray(machine) {
 if (!machine) return;
 if (!Array.isArray(machine.future)) machine.future = [];
}

function render() {
 const container = document.getElementById('machinesContainer');
 container.innerHTML = '';
 state.machines.forEach(m => {
   ensureFutureArray(m);
   const tpl = document.getElementById('machine-template');
   const node = tpl.content.cloneNode(true);
   const root = node.querySelector('div');
   const title = node.querySelector('[data-role="title"]');
   const subtitle = node.querySelector('[data-role="subtitle"]');
   const operatorInput = node.querySelector('[data-role="operator"]');
   const processInput = node.querySelector('[data-role="process"]');
   const cycleInput = node.querySelector('[data-role="cycle"]');
   const trocaInput = node.querySelector('[data-role="troca"]');
   const setupInput = node.querySelector('[data-role="setup"]');
   const observacaoInput = node.querySelector('[data-role="observacao"]');
   const startInput = node.querySelector('[data-role="startTime"]');
   const endInput = node.querySelector('[data-role="endTime"]');
   const producedInput = node.querySelector('[data-role="produced"]');
   const saveBtn = node.querySelector('[data-role="save"]');
   const addHistBtn = node.querySelector('[data-role="addHistory"]');
   const clearHistBtn = node.querySelector('[data-role="clearHistory"]');
   const predictedEl = node.querySelector('[data-role="predicted"]');
   const historyEl = node.querySelector('[data-role="history"]');
   const performanceEl = node.querySelector('[data-role="performance"]');
   const futureInput = node.querySelector('[data-role="futureInput"]');
   const addFutureBtn = node.querySelector('[data-role="addFuture"]');
   const futureList = node.querySelector('[data-role="futureList"]');
   const prioritySelect = node.querySelector('[data-role="prioritySelect"]');
   const sortFutureBtn = node.querySelector('[data-role="sortFuture"]');

   title.textContent = m.id;
   subtitle.textContent = `Operador: ${m.operator||'-'} Â· Ciclo: ${m.cycleMin!=null?formatMinutesToMMSS(m.cycleMin):'-'} Â· PeÃ§a: ${m.process||'-'}`;
   operatorInput.value = m.operator;
   processInput.value = m.process;
   cycleInput.value = m.cycleMin!=null?formatMinutesToMMSS(m.cycleMin):'';
   trocaInput.value = m.trocaMin!=null?formatMinutesToMMSS(m.trocaMin):'';
   setupInput.value = m.setupMin!=null?formatMinutesToMMSS(m.setupMin):'';
   observacaoInput.value = m.observacao || '';
   startInput.value = m.startTime;
   endInput.value = m.endTime;
   producedInput.value = m.produced!=null?m.produced:'';
   predictedEl.textContent = m.predicted ?? 0;

   container.appendChild(root);

   const ctx = root.querySelector('[data-role="chart"]').getContext('2d');
   const chart = new Chart(ctx,{
     type:'bar',
     data:{
       labels:['Previsto','Realizado'],
       datasets:[{
         label:m.id,
         data:[m.predicted||0,m.produced||0],
         backgroundColor:['rgba(0,200,0,0.4)','rgba(255,255,255,0.2)']
       }]
     },
     options:{
       scales:{y:{beginAtZero:true}},
       plugins:{legend:{display:false}}
     }
   });

   function atualizarGrafico() {
     const predicted = m.predicted || 0;
     const produced = (m.produced!=null && m.produced!=='') ? Number(m.produced) : 0;
     const ratio = (predicted > 0) ? (produced / predicted) * 100 : 0;

     let color = 'rgba(255,255,255,0.3)', txtColor='text-gray-400';
     if (ratio < 50) { color='rgba(255,0,0,0.6)'; txtColor='text-red-500'; }
     else if (ratio < 80) { color='rgba(255,255,0,0.6)'; txtColor='text-yellow-400'; }
     else { color='rgba(0,255,0,0.6)'; txtColor='text-green-400'; }

     chart.data.datasets[0].data = [predicted, produced];
     chart.data.datasets[0].backgroundColor = ['rgba(0,200,0,0.4)', color];
     chart.update();

     performanceEl.className = `text-center text-sm font-semibold mt-1 ${txtColor}`;
     performanceEl.textContent = `Desempenho: ${ratio.toFixed(1)}%`;
   }

   function renderHistory() {
     historyEl.innerHTML='';
     if (!m.history || m.history.length===0) {
       historyEl.innerHTML='<div class="text-gray-400">HistÃ³rico vazio</div>';
       return;
     }
     m.history.slice().reverse().forEach(h=>{
       const div=document.createElement('div');
       div.className='mb-1 border-b border-gray-800 pb-1';
       const ts=new Date(h.ts).toLocaleString();
       div.innerHTML=`
         <div class="text-xs text-gray-300">${ts}</div>
         <div class="text-sm">Operador: <strong>${h.operator}</strong> Â· PeÃ§a: <strong>${h.process}</strong></div>
         <div class="text-xs text-gray-400">Previsto: ${h.predicted} Â· Realizado: ${h.produced??'-'} Â· EficiÃªncia: ${h.efficiency??'-'}%</div>
         ${h.observacao ? `<div class='text-xs text-sky-300'>Obs.: ${h.observacao}</div>` : ''}
       `;
       historyEl.appendChild(div);
     });
   }

   function renderFuture() {
     futureList.innerHTML='';
     ensureFutureArray(m);
     if (m.future.length===0) {
       futureList.innerHTML='<div class="text-gray-400">Nenhum processo futuro</div>';
       return;
     }
     m.future.forEach((f,i)=>{
       const div=document.createElement('div');
       div.className=`rounded px-2 py-1 flex justify-between items-center cursor-move prioridade-${f.priority}`;
       const badge=document.createElement('div');
       badge.className='wait-badge';
       if (f.priority==='vermelho'){ badge.style.backgroundColor='#dc2626'; badge.style.color='#000'; }
       else if (f.priority==='amarelo'){ badge.style.backgroundColor='#eab308'; badge.style.color='#000'; }
       else { badge.style.backgroundColor='#16a34a'; badge.style.color='#000'; }
       badge.textContent = String(i+1);

       const left=document.createElement('div');
       left.className='flex items-center gap-2 flex-1';
       const input=document.createElement('input');
       input.value=f.name;
       input.className='bg-transparent flex-1 mr-2 outline-none text-black font-bold';
       input.addEventListener('input',()=>{ f.name=input.value; });
       input.addEventListener('blur',()=>{ salvarFutureAndSync(m); });

       const select=document.createElement('select');
       select.className='bg-gray-200 text-black text-sm rounded px-1 font-bold';
       [['vermelho','ðŸ”´ Urgente'],['amarelo','ðŸŸ¡ Alta'],['verde','ðŸŸ¢ Normal']].forEach(([p,label])=>{
         const opt=document.createElement('option');
         opt.value=p; opt.textContent=label;
         if (p===f.priority) opt.selected=true;
         select.appendChild(opt);
       });
       select.addEventListener('change',()=>{
         f.priority=select.value; salvarFutureAndSync(m); renderFuture();
       });

       const delBtn=document.createElement('button');
       delBtn.className='ml-2 text-black font-bold';
       delBtn.textContent='âœ–';
       delBtn.addEventListener('click',()=>{
         m.future.splice(i,1); salvarFutureAndSync(m); renderFuture();
       });

       left.appendChild(badge);
       left.appendChild(input);
       div.appendChild(left);
       div.appendChild(select);
       div.appendChild(delBtn);

       futureList.appendChild(div);
     });

     Sortable.create(futureList,{
       animation:150,
       onEnd:function(evt){
         const item=m.future.splice(evt.oldIndex,1)[0];
         m.future.splice(evt.newIndex,0,item);
         salvarFutureAndSync(m);
         renderFuture();
       }
     });
   }

   function salvarFirebase(){ REF.child(m.id).set(m); }
   function salvarFutureAndSync(machine){ ensureFutureArray(machine); REF.child(machine.id).set(machine); }

   saveBtn.addEventListener('click',()=>{
     const cycleVal=parseTempoMinutos(cycleInput.value.trim());
     const setupVal=parseTempoMinutos(setupInput.value.trim());
     const trocaVal=parseTempoMinutos(trocaInput.value.trim());
     const startVal=startInput.value||'07:00';
     const endVal=endInput.value||'16:45';
     const producedVal=producedInput.value.trim()===''?null:Number(producedInput.value.trim());

     const pred=calcularPrevisto(cycleVal,trocaVal,setupVal,startVal,endVal);

     m.operator=operatorInput.value.trim();
     m.process=processInput.value.trim();
     m.cycleMin=(cycleInput.value.trim()==='')?null:cycleVal;
     m.setupMin=setupVal||0;
     m.trocaMin=(trocaInput.value.trim()==='')?null:trocaVal;
     m.observacao=observacaoInput.value;
     m.startTime=startVal;
     m.endTime=endVal;
     m.produced=producedVal;
     m.predicted=pred;

     predictedEl.textContent=pred;
     subtitle.textContent=`Operador: ${m.operator||'-'} Â· Ciclo: ${m.cycleMin!=null?formatMinutesToMMSS(m.cycleMin):'-'} Â· PeÃ§a: ${m.process||'-'}`;

     salvarFirebase();
     atualizarGrafico();
   });

   addHistBtn.addEventListener('click',()=>{
     const cycleVal=parseTempoMinutos(cycleInput.value.trim());
     const setupVal=parseTempoMinutos(setupInput.value.trim());
     const trocaVal=parseTempoMinutos(trocaInput.value.trim());
     const startVal=startInput.value||'07:00';
     const endVal=endInput.value||'16:45';
     const producedVal=producedInput.value.trim()===''?null:Number(producedInput.value.trim());

     const predicted=calcularPrevisto(cycleVal,trocaVal,setupVal,startVal,endVal);
     const efficiency=(predicted>0&&producedVal!=null)?((producedVal/predicted)*100).toFixed(1):'-';

     const entry={
       ts:Date.now(),
       operator:operatorInput.value.trim()||'-',
       process:processInput.value.trim()||'-',
       cycleMin:cycleVal,
       setupMin:setupVal,
       trocaMin:(trocaInput.value.trim()===''?null:trocaVal),
       startTime:startVal,
       endTime:endVal,
       produced:producedVal,
       predicted,
       efficiency,
       observacao:observacaoInput.value
     };

     m.history.push(entry);
     renderHistory();
     salvarFirebase();
   });

   clearHistBtn.addEventListener('click',()=>{
     if (!confirm(`Limpar histÃ³rico de ${m.id}?`)) return;
     m.history=[];
     renderHistory();
     salvarFirebase();
   });

   addFutureBtn.addEventListener('click',()=>{
     const nome=futureInput.value.trim();
     const prioridade=prioritySelect.value;
     if (!nome) return alert('Digite o nome do processo futuro.');
     ensureFutureArray(m);
     m.future.push({name:nome,priority:prioridade});
     futureInput.value='';
     salvarFutureAndSync(m);
     renderFuture();
   });

   sortFutureBtn.addEventListener('click',()=>{
     ensureFutureArray(m);
     const ordem={vermelho:1,amarelo:2,verde:3};
     m.future.sort((a,b)=>ordem[a.priority]-ordem[b.priority]);
     salvarFutureAndSync(m);
     renderFuture();
   });

   renderHistory();
   renderFuture();
   atualizarGrafico();
 });
}

REF.on('value',snapshot=>{
 const data=snapshot.val();
 if (!data) {
   state.machines=initDefaultMachines();
   state.machines.forEach(m=>REF.child(m.id).set(m));
 } else {
   state.machines=MACHINE_NAMES.map(name=>{
    const raw=data[name]||{};
    if (!Array.isArray(raw.future)) raw.future=[];
    if (!Array.isArray(raw.history)) raw.history=[];
    return{
      id:name,
      operator:raw.operator||'',
      process:raw.process||'',
      cycleMin:(raw.cycleMin!==undefined&&raw.cycleMin!==null)?raw.cycleMin:null,
      setupMin:(raw.setupMin!==undefined&&raw.setupMin!==null)?raw.setupMin:0,
      trocaMin:(raw.trocaMin!==undefined&&raw.trocaMin!==null)?raw.trocaMin:null,
      observacao:(raw.observacao!==undefined&&raw.observacao!==null)?raw.observacao:'',
      startTime:(raw.startTime)||'07:00',
      endTime:(raw.endTime)||'16:45',
      produced:(raw.produced!==undefined&&raw.produced!==null)?raw.produced:null,
      predicted:(raw.predicted!==undefined&&raw.predicted!==null)?raw.predicted:0,
      history:Array.isArray(raw.history)?raw.history:[],
      future:Array.isArray(raw.future)?raw.future:[]
    };
 });
 }
 render();
});

function exportCSV() {
 const lines=['MÃ¡quina,Operador,Processo,Ciclo (min),Troca (min),Parada (min),InÃ­cio,Fim,Previsto,Realizado,EficiÃªncia (%),ObservaÃ§Ã£o,Processos futuros'];
 state.machines.forEach(m=>{
    const futurosArr=Array.isArray(m.future)?m.future:[];
    const futuros=futurosArr.map((f,idx)=>`${idx+1}. ${f.name}(${f.priority})`).join(' | ');
    lines.push(
      `"${m.id}","${m.operator}","${m.process}",${m.cycleMin||''},${m.trocaMin||''},${m.setupMin||''},${m.startTime},${m.endTime},${m.predicted||0},${m.produced||''},` +
      `${m.history && m.history.length>0?(m.history.at(-1).efficiency||'') : ''},"${m.observacao||''}","${futuros}"`
    );
 });
 const blob=new Blob([lines.join('\n')],{type:'text/csv'});
 const url=URL.createObjectURL(blob);
 const a=document.createElement('a');
 a.href=url;
 a.download='producao_usinagem_v18_6.csv';
 a.click();
 URL.revokeObjectURL(url);
}

function resetAll() {
 if (!confirm('Resetar tudo e apagar dados?')) return;
 state.machines.forEach(m=>{
    REF.child(m.id).set({
      id:m.id,
      operator:'',
      process:'',
      cycleMin:null,
      setupMin:0,
      trocaMin:null,
      observacao:'',
      startTime:'07:00',
      endTime:'16:45',
      produced:null,
      predicted:0,
      history:[],
      future:[]
    });
 });
}

document.getElementById('exportAll').addEventListener('click',exportCSV);
document.getElementById('resetAll').addEventListener('click',resetAll);

</script>
</body>
</html>
